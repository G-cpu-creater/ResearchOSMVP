generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String           @id @default(uuid())
  email         String           @unique
  name          String?
  passwordHash  String           @map("password_hash")
  avatarUrl     String?          @map("avatar_url")
  createdAt     DateTime         @default(now()) @map("created_at")
  updatedAt     DateTime         @updatedAt @map("updated_at")
  conversations AIConversation[]
  projects      Project[]

  @@map("users")
}

model Project {
  id                 String             @id @default(uuid())
  userId             String             @map("user_id")
  title              String
  description        String?
  status             String             @default("active")
  researchType       String?            @map("research_type")
  createdAt          DateTime           @default(now()) @map("created_at")
  updatedAt          DateTime           @updatedAt @map("updated_at")
  lastAccessed       DateTime           @default(now()) @map("last_accessed")
  settings           Json               @default("{}")
  chatMessages       ChatMessage[]
  chatSummary        ChatSummary?
  collaborators      Collaborator[]
  comments           Comment[]
  dataVersions       DataVersion[]
  datasets           Dataset[]
  exportRecords      ExportRecord[]
  files              File[]
  folders            Folder[]
  labNotebookEntries LabNotebookEntry[]
  milestones         Milestone[]
  mlModels           MLModel[]
  pages              Page[]
  papers             Paper[]
  predictions        Prediction[]
  user               User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  visualizations     Visualization[]
  workflows          Workflow[]

  @@index([userId])
  @@index([status])
  @@map("projects")
}

model Page {
  id            String           @id @default(uuid())
  projectId     String           @map("project_id")
  parentPageId  String?          @map("parent_page_id")
  title         String
  icon          String?
  coverImage    String?          @map("cover_image")
  position      Int
  properties    Json             @default("{}")
  createdAt     DateTime         @default(now()) @map("created_at")
  updatedAt     DateTime         @updatedAt @map("updated_at")
  conversations AIConversation[]
  blocks        Block[]
  parentPage    Page?            @relation("PageToPage", fields: [parentPageId], references: [id], onDelete: Cascade)
  childPages    Page[]           @relation("PageToPage")
  project       Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([parentPageId])
  @@map("pages")
}

model Block {
  id            String   @id @default(uuid())
  pageId        String   @map("page_id")
  parentBlockId String?  @map("parent_block_id")
  type          String
  position      Int
  content       Json
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  page          Page     @relation(fields: [pageId], references: [id], onDelete: Cascade)
  parentBlock   Block?   @relation("BlockToBlock", fields: [parentBlockId], references: [id], onDelete: Cascade)
  childBlocks   Block[]  @relation("BlockToBlock")

  @@index([pageId])
  @@index([type])
  @@map("blocks")
}

model Dataset {
  id               String          @id @default(uuid())
  projectId        String          @map("project_id")
  name             String
  technique        String
  instrument       String?
  fileFormat       String?         @map("file_format")
  originalFilename String?         @map("original_filename")
  fileUrl          String          @map("file_url")
  parsedData       Json?           @map("parsed_data")
  metadata         Json?
  rowCount         Int?            @map("row_count")
  columnCount      Int?            @map("column_count")
  fileSize         BigInt?         @map("file_size")
  uploadedAt       DateTime        @default(now()) @map("uploaded_at")
  createdAt        DateTime        @default(now()) @map("created_at")
  project          Project         @relation(fields: [projectId], references: [id], onDelete: Cascade)
  visualizations   Visualization[]

  @@index([projectId])
  @@index([technique])
  @@map("datasets")
}

model Visualization {
  id            String           @id @default(uuid())
  projectId     String           @map("project_id")
  datasetId     String?          @map("dataset_id")
  name          String
  plotType      String           @map("plot_type")
  config        Json
  thumbnailUrl  String?          @map("thumbnail_url")
  createdAt     DateTime         @default(now()) @map("created_at")
  updatedAt     DateTime         @updatedAt @map("updated_at")
  conversations AIConversation[]
  dataset       Dataset?         @relation(fields: [datasetId], references: [id])
  project       Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([datasetId])
  @@map("visualizations")
}

model Paper {
  id            String   @id @default(uuid())
  projectId     String   @map("project_id")
  folderId      String?  @map("folder_id")
  title         String
  authors       String[]
  journal       String?
  year          Int?
  doi           String?
  abstract      String?
  fileUrl       String?  @map("file_url")
  extractedText String?  @map("extracted_text")
  notes         String?
  metadata      Json?
  uploadedAt    DateTime @default(now()) @map("uploaded_at")
  createdAt     DateTime @default(now()) @map("created_at")
  folder        Folder?  @relation(fields: [folderId], references: [id])
  project       Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([folderId])
  @@index([doi])
  @@map("papers")
}

model Folder {
  id        String   @id @default(uuid())
  projectId String   @map("project_id")
  parentId  String?  @map("parent_id")
  name      String
  path      String   @default("/")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  parent    Folder?  @relation("FolderToFolder", fields: [parentId], references: [id], onDelete: Restrict)
  children  Folder[] @relation("FolderToFolder")
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  papers    Paper[]

  @@index([projectId])
  @@index([parentId])
  @@map("folders")
}

model Workflow {
  id           String   @id @default(uuid())
  projectId    String   @map("project_id")
  name         String
  workflowType String   @map("workflow_type")
  steps        Json
  status       String   @default("draft")
  results      Json?
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")
  project      Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([workflowType])
  @@map("workflows")
}

model AIConversation {
  id              String         @id @default(uuid())
  userId          String         @map("user_id")
  projectId       String?        @map("project_id")
  pageId          String?        @map("page_id")
  visualizationId String?        @map("visualization_id")
  contextType     String         @map("context_type")
  messages        Json
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")
  page            Page?          @relation(fields: [pageId], references: [id])
  user            User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  visualization   Visualization? @relation(fields: [visualizationId], references: [id])

  @@index([userId])
  @@index([projectId])
  @@map("ai_conversations")
}

model Milestone {
  id          String    @id @default(uuid())
  projectId   String    @map("project_id")
  title       String
  description String?
  dueDate     DateTime  @map("due_date")
  completed   Boolean   @default(false)
  completedAt DateTime? @map("completed_at")
  progress    Int       @default(0)
  position    Int
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  project     Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@map("milestones")
}

model LabNotebookEntry {
  id        String   @id @default(uuid())
  projectId String   @map("project_id")
  title     String
  content   String
  tags      String[]
  locked    Boolean  @default(false)
  author    String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@map("lab_notebook_entries")
}

model Collaborator {
  id         String    @id @default(uuid())
  projectId  String    @map("project_id")
  userId     String?   @map("user_id")
  email      String
  name       String
  role       String    @default("viewer")
  status     String    @default("pending")
  invitedAt  DateTime  @default(now()) @map("invited_at")
  joinedAt   DateTime? @map("joined_at")
  lastActive DateTime? @map("last_active")
  project    Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([email])
  @@map("collaborators")
}

model Comment {
  id        String   @id @default(uuid())
  projectId String   @map("project_id")
  userId    String   @map("user_id")
  userName  String   @map("user_name")
  content   String
  resolved  Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@map("comments")
}

model Notification {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  type      String
  title     String
  message   String
  read      Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([read])
  @@map("notifications")
}

model DataVersion {
  id        String   @id @default(uuid())
  projectId String   @map("project_id")
  version   String
  message   String
  author    String
  tag       String?
  changes   Json
  datasets  String[]
  snapshot  Json?
  createdAt DateTime @default(now()) @map("created_at")
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@map("data_versions")
}

model MLModel {
  id             String       @id @default(uuid())
  projectId      String       @map("project_id")
  name           String
  modelType      String       @map("model_type")
  targetVariable String       @map("target_variable")
  accuracy       Float
  trainedOn      DateTime     @map("trained_on")
  sampleCount    Int          @map("sample_count")
  parameters     Json?
  metrics        Json?
  status         String       @default("ready")
  createdAt      DateTime     @default(now()) @map("created_at")
  project        Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  predictions    Prediction[]

  @@index([projectId])
  @@map("ml_models")
}

model Prediction {
  id         String   @id @default(uuid())
  modelId    String   @map("model_id")
  projectId  String   @map("project_id")
  parameter  String
  predicted  Float
  confidence Float
  rangeMin   Float    @map("range_min")
  rangeMax   Float    @map("range_max")
  unit       String
  createdAt  DateTime @default(now()) @map("created_at")
  model      MLModel  @relation(fields: [modelId], references: [id], onDelete: Cascade)
  project    Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([modelId])
  @@map("predictions")
}

model ExportRecord {
  id        String   @id @default(uuid())
  projectId String   @map("project_id")
  format    String
  fileName  String   @map("file_name")
  fileUrl   String?  @map("file_url")
  options   Json?
  status    String   @default("completed")
  createdAt DateTime @default(now()) @map("created_at")
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@map("export_records")
}

model ChatMessage {
  id        String   @id @default(uuid())
  projectId String   @map("project_id")
  role      String
  content   String   @db.Text
  tokens    Int?
  metadata  Json?
  createdAt DateTime @default(now()) @map("created_at")
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId, createdAt])
  @@map("chat_messages")
}

model ChatSummary {
  id               String   @id @default(uuid())
  projectId        String   @unique @map("project_id")
  summary          String   @db.Text
  messageCount     Int      @default(0) @map("message_count")
  lastSummarizedAt DateTime @map("last_summarized_at")
  updatedAt        DateTime @updatedAt @map("updated_at")
  project          Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("chat_summaries")
}

model File {
  id         String   @id @default(uuid())
  name       String
  type       String // 'file' or 'folder'
  extension  String? // file extension (e.g., 'pdf', 'png')
  size       Int? // file size in bytes
  url        String? // storage URL for files
  parentId   String?  @map("parent_id")
  projectId  String   @map("project_id")
  isExpanded Boolean  @default(false) @map("is_expanded")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  parent   File?   @relation("FileHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children File[]  @relation("FileHierarchy")
  project  Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([parentId])
  @@map("files")
}
